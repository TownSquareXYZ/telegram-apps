---
outline:
  - 2
  - 4
---

# Данные инициализации

В списке [параметров запуска](launch-parameters) данные инициализации находятся в параметре `tgWebAppData`. Это набор данных, в основном связанный с конкретным пользователем, запустившим мини-приложение.

Отличительной особенностью данных инициализации является то, что их можно использовать в качестве фактора аутентификации или авторизации. Поэтому не забывайте о безопасности приложения
и, в частности, данных инициализации.

## Извлечение

Чтобы извлечь данные инициализации, разработчик может использовать функцию `retrieveLaunchParams` из [@telegram-apps/sdk](../packages/telegram-apps-sdk/2-x).

```typescript
import { retrieveLaunchParams } from '@telegram-apps/sdk';

const { initDataRaw, initData } = retrieveLaunchParams();
```

## Авторизация и Аутентификация

Особенностью данных инициализации является возможность их использования в качестве фактора для авторизации или аутентификации. Дело в том, что данные, сгенерированные нативным приложением Telegram, подписываются
секретным ключом Telegram-бота, после чего сгенерированная подпись размещается рядом с самими параметрами.

Поэтому, зная секретный ключ Telegram-бота, разработчик может проверить подпись параметров и убедиться, что они действительно были отправлены указанному пользователю.

Кроме того, операция проверки подписи выполняется достаточно быстро и не требует больших ресурсов сервера.

::: tip

Примеры использования различных языков программирования можно найти в [этой](authorizing-user.md) статье.

:::

## Отправка на сервер

Чтобы авторизовать пользователя на сервере, разработчику нужно передать данные инициализации, которые были указаны при запуске мини-приложения. Чтобы упростить задачу, разработчик может передавать их при каждом запросе на сервер, после чего проверка подписи выполняется на стороне сервера.

Пример того, как разработчик может отправить данные инициализации на сервер:

```typescript
import { retrieveLaunchParams } from '@telegram-apps/sdk';

const { initDataRaw } = retrieveLaunchParams();

fetch('https://example.com/api', {
  method: 'POST',
  headers: {
    Authorization: `tma ${initDataRaw}`
  },
});
```

В свою очередь, на стороне сервера должны быть выполнены следующие действия:

1. Получите значение хедера `Authorization`;
2. Убедитесь, что первая его часть равна `tma`;
3. Получите данные инициализации и [валидируйте](#validating) их подпись.

Если этот алгоритм работает успешно, серверная часть приложения может доверять переданным данным инициализации.

## Валидация

Валидация данных инициализации - одна из важнейших составляющих взаимодействия
между клиентом и сервером. Она гарантирует, что данным инициализации можно доверять и использовать их при выполнении кода в будущем.

> [!СОВЕТ]
> Чтобы избежать возможных проблем, связанных с процессом валидации данных инициализации, рекомендуется использовать хорошо зарекомендовавшие себя и протестированные пакеты:
>
> - Для Node: [@telegram-apps/init-data-node](../packages/telegram-apps-init-data-node)
> - Для GoLang: [init-data-golang](../packages/init-data-golang.md)

### Использование токена Telegram-бота

Валидация данных инициализации - одна из важнейших составляющих коммуникации между клиентом и сервером. Она гарантирует, что данным инициализации можно доверять и использовать их при выполнении кода в будущем.

Зная, что начальные данные представлены в виде списка параметров запроса, для их валидации разработчик должен выполнить следующие действия:

1. Выполните итерацию по всем парам key-value и создайте массив строковых значений в формате `{key}={value}`. Ключ `hash` следует исключить, но мемоизировать. Он представляет собой подпись данных инициализации и будет использоваться на последнем этапе процесса валидации.
2. Отсортируйте вычисленный массив в алфавитном порядке.
3. Создайте HMAC-SHA256 с помощью ключа `WebAppData` и примените его к токену Telegram-бота, который привязан к вашему мини-приложению.
4. Создайте HMAC-SHA256, используя результат предыдущего шага в качестве ключа. Примените его к массиву пар, объединенных с помощью символа разделения строки (`\n`), полученному на 2 шаге, и представьте результат в виде последовательности шестнадцатеричных символов.
5. Сравните значение `hash`, полученное на 1-м шаге, с результатом 4-го шага.
6. Если эти значения равны, переданным данным инициализации можно доверять.

#### Пример

##### 1. Исходные данные

- **Токен Telegram-бота**: Это значение используется для подписания данных инициализации, и оно потребуется на следующих этапах процесса валидации.

```
5768337691:AAH5YkoiEuPk8-FZa32hStHTqXiLPtAEhx8
```

- Данные инициализации: эти данные должны передаваться непосредственно из мини-приложения на сервер без изменений.

```
query_id=AAHdF6IQAAAAAN0XohDhrOrc&user=%7B%22id%22%3A279058397%2C%22first_name%22%3A%22Vladislav%22%2C%22last_name%22%3A%22Kibenko%22%2C%22username%22%3A%22vdkfrost%22%2C%22language_code%22%3A%22ru%22%2C%22is_premium%22%3Atrue%7D&auth_date=1662771648&hash=c501b71e775f74ce10e377dea85a7ea24ecd640b223ea86dfe453e0eaed2e2b2
```

##### 2. Создание пары «Key-Value» и извлечение подписи.

В соответствии с процессом валидации необходимо проанализировать данные инициализации как параметры запроса. Затем возьмите все пары «key-value», исключая ключ `hash`, объедините их с помощью символа `=` и отсортируйте в алфавитном порядке. Итоговый массив должен быть объединён с помощью символа разделения строки (`\n`).

Результат будет следующим:

```
auth_date=1662771648\nquery_id=AAHdF6IQAAAAAN0XohDhrOrc\nuser={"id":279058397,"first_name":"Vladislav","last_name":"Kibenko","username":"vdkfrost","language_code":"ru","is_premium":true}
```

Подпись - это значение в ключе `hash`. В данном случае это будет:

```
c501b71e775f74ce10e377dea85a7ea24ecd640b223ea86dfe453e0eaed2e2b2
```

##### 3. Создание подписи токена Telegram-бота

Чтобы проверить, корректность подписи данных инициализации, нам нужно подписать их самостоятельно. Сначала мы должны создать подпись HMAC-SHA256 для токена Telegram-бота, используя значение `WebAppData` в качестве криптографического ключа.

Вот результат:

```
HMAC-SHA256(
  5768337691:AAH5YkoiEuPk8-FZa32hStHTqXiLPtAEhx8,
  WebAppData
) = a5c609aa52f63cb5e6d8ceb6e4138726ea82bbc36bb786d64482d445ea38ee5f
```

> [!ВАЖНО]
> Полученное значение не должно быть преобразовано в шестнадцатеричную последовательность, как показано выше. На следующем шаге используйте его как есть (массив байтов), но вы можете использовать шестнадцатеричное значение, чтобы проверить, правильно ли ваш код генерирует хеш.

##### 4. Создание и сравнение подписи данных инициализации

Наконец, мы вычисляем подпись данных инициализации.

Для этого создайте ещё одну подпись HMAC-SHA256, используя преобразованные данные инициализации из шага 2, а в качестве криптографического ключа - хэш, полученный на шаге 3.

Вот результат:

```
HMAC-SHA256(
  auth_date=1662771648\nquery_id=AAHdF6IQAAAAAN0XohDhrOrc\nuser={"id":279058397,"first_name":"Vladislav","last_name":"Kibenko","username":"vdkfrost","language_code":"ru","is_premium":true},
  *signature from Step 3*,
) = c501b71e775f74ce10e377dea85a7ea24ecd640b223ea86dfe453e0eaed2e2b2
```

Теперь, сравнив результат со значением `hash` из шага 2, мы можем подтвердить, что они идентичны. Это означает, что мы можем доверять переданным данным инициализации.

### Использование публичного ключа Telegram

Ещё одна полезная функция Telegram - это возможность валидировать данные инициализации без знания секретного токена бота, но зная его идентификатор.

На данный момент Telegram предоставляет два публичных ключа Ed25519:

- Для рабочей среды: `e7bf03a2fa4602af4580703d88dda5bb59f32ed8b02a56c187fe7d34caed242d`
- Для тестовой среды: `40055058a4ee38156a06562e52eece92a771bcd8346a8c4615cb7376eddf72ec`

Чтобы выполнить такую валидацию (она называется сторонней проверкой), выполните следующие действия:

1. Выполните итерацию по всем парам «key-value» и создайте массив строковых значений в формате` {key}={value}`. Ключ `hash` должен быть исключён. Ключ `signature` также следует исключить, но мемоизировать. Он представляет собой подпись данных инициализации и будет использоваться на последнем этапе процесса валидации.
2. Отсортируйте вычисленный массив в алфавитном порядке.
3. Объедините идентификатор Telegram-бота, выдавшего данные инициализации, со строкой `WebAppData` с помощью двоеточия (`:`) и добавьте символ разделения строки (`\n`).
4. Объедините пары из 2 шага с помощью символа разделения строки (`\n`) и добавьте итоговое значение к значению из 3 шага.
5. Проверьте подпись Ed25519, используя значение из ключа `signature` данных инициализации.
6. Если верификация прошла успешно, данным инициализации можно доверять.

#### Пример

##### 1. Исходные данные

- **Рабочая среда**: мы валидируем данные инициализации в рабочей среде. Итак, будет использован следующий публичный ключ Ed25519:

```
e7bf03a2fa4602af4580703d88dda5bb59f32ed8b02a56c187fe7d34caed242d
```

- **Данные инициализации**: эти данные должны передаваться непосредственно из мини-приложения на сервер без изменений.

```
user=%7B%22id%22%3A279058397%2C%22first_name%22%3A%22Vladislav%20%2B%20-%20%3F%20%5C%2F%22%2C%22last_name%22%3A%22Kibenko%22%2C%22username%22%3A%22vdkfrost%22%2C%22language_code%22%3A%22ru%22%2C%22is_premium%22%3Atrue%2C%22allows_write_to_pm%22%3Atrue%2C%22photo_url%22%3A%22https%3A%5C%2F%5C%2Ft.me%5C%2Fi%5C%2Fuserpic%5C%2F320%5C%2F4FPEE4tmP3ATHa57u6MqTDih13LTOiMoKoLDRG4PnSA.svg%22%7D&chat_instance=8134722200314281151&chat_type=private&auth_date=1733584787&hash=2174df5b000556d044f3f020384e879c8efcab55ddea2ced4eb752e93e7080d6&signature=zL-ucjNyREiHDE8aihFwpfR9aggP2xiAo3NSpfe-p7IbCisNlDKlo7Kb6G4D0Ao2mBrSgEk4maLSdv6MLIlADQ
```

##### 2. Создание пары «Key-Value» и извлечение подписи.

В соответствии с процессом валидации, мы должны проанализировать данные инициализации, как параметры запроса. Затем возьмите все пары «key-value», исключая ключи `hash` и `signature`, объедините их с помощью символа `=` и отсортируйте в алфавитном порядке. Итоговый массив должен быть объединён с помощью символа разделения строки (`\n`).

Результат будет следующим:

```
auth_date=1733584787\nchat_instance=8134722200314281151\nchat_type=private\nuser={"id":279058397,"first_name":"Vladislav + - ? \/","last_name":"Kibenko","username":"vdkfrost","language_code":"ru","is_premium":true,"allows_write_to_pm":true,"photo_url":"https:\/\/t.me\/i\/userpic\/320\/4FPEE4tmP3ATHa57u6MqTDih13LTOiMoKoLDRG4PnSA.svg"}
```

Подпись - это значение в ключе `signature`. В данном случае она такая:

```
zL-ucjNyREiHDE8aihFwpfR9aggP2xiAo3NSpfe-p7IbCisNlDKlo7Kb6G4D0Ao2mBrSgEk4maLSdv6MLIlADQ
```

Тем не менее на следующих шагах мы должны преобразовать её в массив байтов, предполагая, что это значение закодировано в base64.

> [!ВНИМАНИЕ]
> На данный момент Telegram отправляет неверную подпись. Некоторые языки программирования (например, Go) рассматривают подпись как недопустимое значение base64, если она не полностью соответствует стандарту.
> При использовании подписи не забывайте добавить паддинги (символы `=`) в конец значения, если они необходимы. В данном случае правильным значением будет:
>
> ```
> zL-ucjNyREiHDE8aihFwpfR9aggP2xiAo3NSpfe-p7IbCisNlDKlo7Kb6G4D0Ao2mBrSgEk4maLSdv6MLIlADQ==
> ```

##### 3. Создание строки проверки данных (Data-Check String)

Теперь давайте создадим строку проверки данных (data-check string). Для этого нужно объединить токен Telegram-бота со строкой `WebAppData` с помощью двоеточия (`:`) и добавить символ разделения строки. Затем к полученной строке необходимо добавить отсортированные данные инициализации из предыдущего шага.

Вот результат:

```
7342037359:WebAppData\nauth_date=1733584787\nchat_instance=8134722200314281151\nchat_type=private\nuser={"id":279058397,"first_name":"Vladislav + - ? \/","last_name":"Kibenko","username":"vdkfrost","language_code":"ru","is_premium":true,"allows_write_to_pm":true,"photo_url":"https:\/\/t.me\/i\/userpic\/320\/4FPEE4tmP3ATHa57u6MqTDih13LTOiMoKoLDRG4PnSA.svg"}
```

##### 4. Проверка подписи Ed25519

И, наконец, мы проверяем подпись.

Пока мы находимся в рабочей среде, мы будем использовать соответствующий публичный ключ Ed25519:

```
e7bf03a2fa4602af4580703d88dda5bb59f32ed8b02a56c187fe7d34caed242d
```

Это значение необходимо преобразовать в массив байтов, предполагая, что значение представляет собой шестнадцатеричную последовательность.

И вот результат проверки:

```
Ed25519-Verify(
  7342037359:WebAppData\nauth_date=1733584787\nchat_instance=8134722200314281151\nchat_type=private\nuser={"id":279058397,"first_name":"Vladislav + - ? \/","last_name":"Kibenko","username":"vdkfrost","language_code":"ru","is_premium":true,"allows_write_to_pm":true,"photo_url":"https:\/\/t.me\/i\/userpic\/320\/4FPEE4tmP3ATHa57u6MqTDih13LTOiMoKoLDRG4PnSA.svg"},
  *public key (as a hexadecimal sequence) converted to bytes array*,
  *signature (as a base64-encoded value) converted to bytes array*
) == true
```

Если проверка прошла успешно, данным инициализации можно доверять.

### Рекомендация

В реальных приложениях рекомендуется использовать дополнительные механизмы для проверки данных инициализации. Например, можно добавить дату истечения срока действия. Эту проверку можно реализовать с помощью параметра `auth_date`, который отвечает за дату создания параметров.
Это решение позволит в случае кражи данных инициализации предотвратить их постоянное использование злоумышленником.

## Список параметров

В этом разделе представлен полный список параметров, используемых в данных инициализации.

<table>
<thead>
  <tr>
    <th>Параметр</th>
    <th>Тип</th>
    <th>Описание</th>
  </tr>
</thead>
<tbody>
  <tr>
    <td>auth_date</td>
    <td>
      <code>number</code>
    </td>
    <td>
      Дата создания данных инициализации. Это число, представляющее временную метку Unix.
    </td>
  </tr>

  <tr>
    <td>can_send_after</td>
    <td>
      <code>number</code>
    </td>
    <td>
      <i>Опционально</i>. Количество секунд, по истечении которых сообщение может быть отправлено с помощью метода
      <a href="https://core.telegram.org/bots/api#answerwebappquery">answerWebAppQuery</a>.
    </td>
  </tr>

  <tr>
    <td>chat</td>
    <td>
      <a href="#chat">
        <code>Chat</code>
      </a>
    </td>
    <td>
      <i>Опционально</i>. Объект, содержащий данные о чате, в котором бот был запущен через меню вложений. Возвращается для супергрупп, каналов и групповых чатов - только для мини-приложений, запущенных через меню вложений.
    </td>
  </tr>

  <tr>
    <td>chat_type</td>
    <td>
      <code>string</code>
    </td>
    <td>
      <i>Опционально</i>. Тип чата, из которого было открыто мини-приложение. Значения:      
<ul>
        <li>
          <code>sender</code>
        </li>
        <li>
          <code>private</code>
        </li>
        <li>
          <code>group</code>
        </li>
        <li>
          <code>supergroup</code>
        </li>
        <li>
          <code>channel</code>
        </li>
      </ul>
      Возвращается только для приложений, открытых по прямой ссылке.
    </td>
  </tr>

  <tr>
    <td>chat_instance</td>
    <td>
      <code>string</code>
    </td>
    <td>
      <i>Опционально</i>. Глобальный идентификатор, указывающий на чат, из которого было открыто мини-приложение.
      Возвращается только для приложений, открытых по прямой ссылке.
    </td>
  </tr>

  <tr>
    <td>hash</td>
    <td>
      <code>string</code>
    </td>
    <td>Подпись данных инициализации.</td>
  </tr>

  <tr>
    <td>query_id</td>
    <td>
      <code>string</code>
    </td>
    <td>
      <i>Опционально</i>. Уникальный идентификатор сессии мини-приложения. Используется в процессе отправки сообщения с помощью метода
      <a href="https://core.telegram.org/bots/api#answerwebappquery">answerWebAppQuery</a>.
    </td>
  </tr>

  <tr>
    <td>receiver</td>
    <td>
      <a href="#user">
        <code>User</code>
      </a>
    </td>
    <td>
      <i>Опционально</i>. Объект, содержащий данные о партнере по чату текущего пользователя в чате, в котором бот был запущен через меню вложений. Возвращается только для приватных чатов и только для мини-приложений, запущенных через меню вложений.
    </td>
  </tr>

  <tr>
    <td>start_param</td>
    <td>
      <code>string</code>
    </td>
    <td>
      <i>Опционально</i>. Значение параметра <code>startattach</code> или <code>startapp</code> запроса, указанного в ссылке. Возвращается только для мини-приложений, открытых через меню вложений.
    </td>
  </tr>

  <tr>
    <td>user</td>
    <td>
      <a href="#user">
        <code>User</code>
      </a>
    </td>
    <td>
      <i>Опционально</i>. Объект, содержащий информацию о текущем пользователе.
    </td>
  </tr>

</tbody>
</table>

## Другие типы

### Chat

Описывает информацию о чате.

<table>
<thead>
  <tr>
    <th>Свойство</th>
    <th>Тип</th>
    <th>Описание</th>
  </tr>
</thead>
<tbody>
  <tr>
    <td>id</td>
    <td>
      <code>number</code>
    </td>
    <td>Уникальный ID чата.</td>
  </tr>

  <tr>
    <td>type</td>
    <td>
      <code>string</code>
    </td>
    <td>
      Тип чата. Значения:      
<ul>
        <li>
          <code>group</code>
        </li>
        <li>
          <code>supergroup</code>
        </li>
        <li>
          <code>channel</code>
        </li>
      </ul>
    </td>
  </tr>

  <tr>
    <td>title</td>
    <td>
      <code>string</code>
    </td>
    <td>Название чата.</td>
  </tr>

  <tr>
    <td>photo_url</td>
    <td>
      <code>string</code>
    </td>
    <td>
      <i>Опционально</i>. Ссылка на фото чата. Фотография может быть в форматах <code>.jpeg</code> и
      <code>.svg</code>. Возвращается только для мини-приложений, открытых через меню вложений.
    </td>
  </tr>

  <tr>
    <td>username</td>
    <td>
      <code>string</code>
    </td>
    <td>
      <i>Опционально</i>. Логин пользователя чата.
    </td>
  </tr>
</tbody>
</table>

### User

Описывает информацию о пользователе или боте.

| Свойство                                                                                | Тип       | Описание                                                                                                                                                                                                                                            |
| --------------------------------------------------------------------------------------- | --------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| added_to_attachment_menu | `boolean` | _Опционально_. True, если этот пользователь добавил бота в меню вложений.                                                                                                                                           |
| allows_write_to_pm       | `boolean` | _Опционально_. True, если этот пользователь разрешил боту отправлять ему сообщения.                                                                                                                                 |
| is_premium                                                         | `boolean` | _Опционально_. Приобрел ли пользователь Telegram Premium.                                                                                                                                                           |
| first_name                                                         | `string`  | Имя пользователя или бота.                                                                                                                                                                                                          |
| id                                                                                      | `number`  | ID бота или пользователя.                                                                                                                                                                                                           |
| is_bot                                                             | `boolean` | _Опционально_. Является ли пользователь ботом.                                                                                                                                                                      |
| last_name                                                          | `string`  | _Опционально_. Фамилия пользователя.                                                                                                                                                                                |
| language_code                                                      | `string`  | _Опционально_. [IETF](https://en.wikipedia.org/wiki/IETF_language_tag) языка пользователя.                                                                                                                          |
| photo_url                                                          | `string`  | _Опционально_. Ссылка на фотографию пользователя или бота. Фотографии могут быть в формате `.jpeg` и `.svg`. Возвращается только для мини-приложений, открытых через меню вложений. |
| имя пользователя                                                                        | `string`  | _Опционально_. Логин бота или пользователя.                                                                                                                                                                         |
