---
outline:
  - 2
  - 3
---

# События

События - это сигналы, отправляемые из нативного приложения Telegram в случае выполнения какого-либо внешнего действия. Как и методы, каждое событие имеет свое уникальное имя и параметры.

## Web

Как упоминалось ранее, в веб-версии используется стандартный способ взаимодействия между фреймами. Это означает, что
родительский фрейм может отправлять события с помощью функции `window.postMessage`. Чтобы обработать этот тип сообщений, достаточно добавить слушателя события `message` в глобальный объект `window`:

```typescript
window.addEventListener('message', ...);
```

Нативное приложение отправит событие с `data: string`, в качестве объекта JSON, преобразованного в строку. Этот объект имеет тот же интерфейс, который мы определили в разделе
["Методы"](methods.md#web):

```typescript
interface MessageJSON {
  eventType: string;
  eventData: any;
}
```

Затем давайте рассмотрим, как мы можем обработать событие из приложения Telegram:

```typescript
window.addEventListener('message', ({ data }) => {
  const { eventType, eventData } = JSON.parse(data);
  console.log(eventType, eventData);
});
```

::: warning

В этом коде мы предположили, что событие `message` отправляется только нативным приложением, что не всегда верно в реальных приложениях. Кроме того, мы не проверяли, действительно ли `data` имеет тип `string`. Не забудьте проверить каждый тип и соответствующим образом обработать входящие события.

:::

## Десктопная, мобильная и Windows Phone версии

Десктопная, мобильная и Windows Phone версии Telegram не используют метод, описанный в предыдущем разделе. Они делают это немного необычным способом. Первое, что должен знать разработчик: если Telegram необходимо запустить событие, он вставляет код JavaScript, который вызывает глобально определенную функцию.

Например:

```typescript
window.Telegram.WebView.receiveEvent('popup_closed', {
  button_id: 'cancel'
});
```

Путь к этой функции зависит от платформы:

- `window.TelegramGameProxy.receiveEvent` - Telegram Desktop;
- `window.Telegram.WebView.receiveEvent` - Telegram для iOS и Android;
- `window.TelegramGameProxy_receiveEvent` - Windows Phone

Все эти функции имеют одинаковую сигнатуру:

```typescript
type ReceiveEvent = (eventType: string, eventData: unknown) => void;
```

Итак, решение довольно простое. Для обработки входящих событий нам нужно создать функцию такого типа и назначить ее для всех 3 путей.

## Прослушивание событий

Работа со всеми возможными средами для приложения разработчика может быть сложной задачей. Чтобы упростить
этот процесс, сообщество разработало пакет [@telegram-apps/sdk](../packages/telegram-apps-sdk/2-x), который значительно облегчает интеграцию.

Вот как его можно использовать:

```ts
import { on } from '@telegram-apps/sdk';

// Старт прослушивания события "viewport_changed". Возвращаемое значение -
// это функция, которая удаляет этот слушатель.
const removeListener = on('viewport_changed', payload => {
  console.log('Viewport changed:', payload);
});

// Удаление этого слушателя.
removeListener();
```

Подробнее о вызове методов можно узнать в [документации](../packages/telegram-apps-bridge/events.md#listening-to-events) пакета.

## Доступные события

Этот раздел содержит список событий, отправленных из Telegram: их названия, описание и параметры. В названии раздела указана минимальная версия, из которой могут быть отправлены события этого раздела.

### `back_button_pressed`

Доступно с **версии 6.1**

Пользователь нажал на кнопку ["Назад"](back-button.md).

### `biometry_auth_requested`

Доступно с **версии 7.2**

Запрос на биометрическую аутентификацию выполнен. Это событие обычно происходит в ответ на метод
[web_app_request_auth](methods.md#web-app-biometry-request-auth).

Если аутентификация прошла успешно, событие содержит токен из локального secure storage.

| Поле   | Тип      | Описание                                                                                                                                                                                |
| ------ | -------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| status | `string` | Статус аутентификации. Возможные значения: `failed` или `authorized`.                                                                   |
| token  | `string` | _Опционально_. Токен из локального secure storage, сохраненный ранее. Передается только в том случае, если `status` равно `authorized`. |

### `biometry_info_received`

Доступно с **версии 7.2**

Настройки биометрии были получены.

| Поле                                  | Тип       | Описание                                                                                                                                         |
| ------------------------------------- | --------- | ------------------------------------------------------------------------------------------------------------------------------------------------ |
| available                             | `boolean` | Показывает, доступна ли биометрия.                                                                                               |
| access_requested | `boolean` | Показывает, было ли запрошено разрешение на использование биометрических данных.                                                 |
| access_granted   | `boolean` | Показывает, было ли получено разрешение на использование биометрических данных.                                                  |
| device_id        | `string`  | Уникальный идентификатор устройства, который можно использовать для сопоставления токена с устройством.                          |
| token_saved      | `boolean` | Показывает, содержит ли локальный secure storage ранее сохраненный токен.                                                        |
| type                                  | `string`  | Тип биометрии, доступный на устройстве в данный момент. Возможные значения: `face` или `finger`. |

### `biometry_token_updated`

Доступно с **версии 7.2**

Биометрический токен был обновлен.

| Поле   | Тип      | Описание                                                                                                        |
| ------ | -------- | --------------------------------------------------------------------------------------------------------------- |
| status | `string` | Статус обновления. Возможные значения: `updated` или `removed`. |

### `clipboard_text_received`

Доступно с **версии 6.4**

Приложение Telegram пыталось извлечь текст из буфера обмена.

| Поле                        | Тип                 | Описание                                                                                                                                                                                                                                                   |
| --------------------------- | ------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| req_id | `string`            | Передаваемое при вызове метода [web_app_read_text_from_clipboard](methods.md#web-app-read-text-from-clipboard) значение `req_id`. |
| data                        | `string` или `null` | _Опционально_. Данные, извлеченные из буфера обмена. Возвращаемое значение будет иметь тип `string` только в том случае, если приложение имеет доступ к буферу обмена.                                     |

### `content_safe_area_changed`

Доступно с **версии 8.0**

Это событие происходит каждый раз, когда изменяется безопасная зона контента в приложении Telegram пользователя. Например, когда пользователь переключается на альбомную ориентацию.

**Безопасная зона** гарантирует, что контент не будет перекрывать элементы пользовательского интерфейса Telegram.

**Безопасная зона контента** - это часть безопасной зоны устройства, которое охватывает элементы пользовательского интерфейса Telegram.

| Поле   | Тип      | Описание                                                                                                        |
| ------ | -------- | --------------------------------------------------------------------------------------------------------------- |
| top    | `number` | Верхний инсет в пикселях, обозначающий пространство, которого следует избегать в верхней части области контента |
| bottom | `number` | Нижний инсет в пикселях, обозначающий пространство, которое следует избегать в нижней части области контента    |
| left   | `number` | Левый инсет в пикселях, обозначающий пространство, которое следует избегать с левой стороны области контента    |
| right  | `number` | Правый инсет в пикселях, обозначающий пространство, которое следует избегать с правой стороны области контента  |

### `custom_method_invoked`

Доступно с **версии 6.9**

Вызов пользовательского метода завершен.

| Поле                        | Тип       | Описание                                                                 |
| --------------------------- | --------- | ------------------------------------------------------------------------ |
| req_id | `string`  | Уникальный идентификатор этого вызова.                   |
| result                      | `unknown` | _Опционально_. Результат вызова метода.  |
| error                       | `string`  | _Опционально_. Код ошибки вызова метода. |

### `emoji_status_access_requested`

Доступно с **версии 8.0**

Был запрошен доступ для установки пользовательского эмодзи статуса.

| Поле   | Тип      | Описание                                                                                                       |
| ------ | -------- | -------------------------------------------------------------------------------------------------------------- |
| status | `string` | Статус запроса. Возможные значения: `allowed` или `cancelled`. |

### `emoji_status_failed`

Доступно с **версии 8.0**

Не удалось установить пользовательский эмодзи статус.

| Поле  | Тип      | Описание                                                                                                                             |
| ----- | -------- | ------------------------------------------------------------------------------------------------------------------------------------ |
| error | `string` | Причина сбоя при установке эмодзи. Возможные значения: `SUGGESTED_EMOJI_INVALID` или `USER_DECLINED` |

### `emoji_status_set`

Доступно с **версии 8.0**

Пользовательский эмодзи статус установлен.

### `fullscreen_changed`

Доступно с **версии 8.0**

Происходит каждый раз, когда мини-приложение входит в полноэкранный режим или выходит из него.

| Поле                               | Тип       | Описание                                                                                   |
| ---------------------------------- | --------- | ------------------------------------------------------------------------------------------ |
| is_fullscreen | `boolean` | Указывает, находится ли приложение в данный момент в полноэкранном режиме. |

### `fullscreen_failed`

Доступно с **версии 8.0**

Происходит всякий раз, когда мини-приложение переходит в полноэкранный режим или выходит из него.

| Поле  | Тип      | Описание                                                                                                                                            |
| ----- | -------- | --------------------------------------------------------------------------------------------------------------------------------------------------- |
| error | `string` | Ошибка состояния полноэкранного режима. Возможные значения: `UNSUPPORTED` или `ALREADY_FULLSCREEN`. |

### `home_screen_added`

Доступно с **версии 8.0**

Мини-приложение было добавлено на главный экран устройства.

### `home_screen_checked`

Доступно с **версии 8.0**

Проверен статус мини-приложения, добавляемого на главный экран.

| Поле   | Тип      | Описание                                                                                                                                                |
| ------ | -------- | ------------------------------------------------------------------------------------------------------------------------------------------------------- |
| status | `string` | Статус мини-приложения, добавляемого на главный экран. Возможные значения: `unsupported`, `unknown`, `added` и `missed` |

- `unsupported` – функция не поддерживается, и добавить значок на главный экран невозможно,
- `unknown` – функция поддерживается и значок может быть добавлен, но невозможно
  определить, был ли этот значок уже добавлен ранее,
- `added` – значок уже был добавлен на главный экран,
- `missed` – значок не был добавлен на главный экран.

### `home_screen_failed`

Доступно с **версии 8.0**

Пользователь отклонил запрос на добавление текущего мини-приложения на главный экран устройства.

### `invoice_closed`

Инвойс был закрыт.

| Поле   | Тип      | Описание                                                                                                                                                                                    |
| ------ | -------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| slug   | `string` | Передаваемое во время вызова метода [web_app_open_invoice](methods.md#web-app-open-invoice) значение `slug`. |
| status | `string` | Статус инвойса. Возможные значения: `paid`, `failed`, `pending` или `cancelled`.                                                            |

### `main_button_pressed`

Пользователь кликнул по [Главной кнопке](main-button.md).

### `phone_requested`

Доступно с **версии 6.9**

Приложение получило статус запроса доступа к телефону.

| Поле   | Тип      | Описание                                                                                           |
| ------ | -------- | -------------------------------------------------------------------------------------------------- |
| status | `string` | Статус запроса. Значения могут быть только `sent` или `cancelled`. |

### `popup_closed`

[Всплывающее окно](popup.md) было закрыто.

| Поле                           | Тип      | Описание                                                                                                                                                                                   |
| ------------------------------ | -------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| button_id | `string` | _Опционально_. Идентификатор нажатой кнопки. Если всплывающее окно было закрыто без нажатия какой-либо кнопки, это свойство будет опущено. |

### `qr_text_received`

Доступно с **версии 6.4**

QR-сканер отсканировал несколько QR-кодов и получил их содержимое.

| Поле | Тип      | Описание                                                                 |
| ---- | -------- | ------------------------------------------------------------------------ |
| data | `string` | _Опционально_. Данные, полученные из QR. |

### `reload_iframe`

Родительский фрейм запросил перезагрузку текущего фрейма.

### `safe_area_changed`

Доступно с **версии 8.0**

Это событие происходит каждый раз, когда в приложении Telegram пользователя изменяется безопасная зона, например, когда пользователь переключается на альбомную ориентацию.

**Безопасная зона** предотвращает наложение контента на элементы пользовательского интерфейса системы, такие как выемки или панели навигации.

| Поле   | Тип      | Описание                                                                                             |
| ------ | -------- | ---------------------------------------------------------------------------------------------------- |
| top    | `number` | Верхний инсет в пикселях, обозначающий пространство, которое следует избегать в верхней части экрана |
| bottom | `number` | Нижний инсет в пикселях, обозначающий пространство, которое следует избегать в нижней части экрана   |
| left   | `number` | Левый инсет в пикселях, обозначающий пространство, которое следует избегать с левой стороны экрана   |
| right  | `number` | Правый инсет в пикселях, обозначающий пространство, которое следует избегать с правой стороны экрана |

### `scan_qr_popup_closed`

Доступно с **версии 6.4**

QR-сканер был закрыт.

### `secondary_button_pressed`

Доступно с **версии 7.10**

Пользователь нажал на дополнительную кнопку.

### `set_custom_style`

Событие, которое обычно отправляется веб-приложением Telegram. Его payload представляет собой html-содержимое с тегом `<style/>`
html, который разработчик может использовать. Таблица стилей, описанная в payload, поможет разработчику
стилизовать полосу прокрутки приложения (но он может сделать это и самостоятельно).

### `settings_button_pressed`

Доступно с **версии 6.1**

Это событие происходит каждый раз, при нажатии [кнопки настройки](settings-button.md)

### `theme_changed`

Это событие происходит каждый раз при изменении [темы](theming.md) в приложении Telegram (включая переключение на ночной режим).

| Поле                              | Тип                      | Описание                                                                                                                     |
| --------------------------------- | ------------------------ | ---------------------------------------------------------------------------------------------------------------------------- |
| theme_params | `Record<string, string>` | Карта, в которой ключ - это ключ таблицы стилей темы, а значение - соответствующий цвет в формате `#RRGGBB`. |

### `viewport_changed`

Происходит всякий раз, когда [область просмотра](viewport.md) была изменена. Например, когда пользователь
начал перетаскивать приложение или вызвал метод расширения.

| Поле                                                      | Тип       | Описание                                                                                                            |
| --------------------------------------------------------- | --------- | ------------------------------------------------------------------------------------------------------------------- |
| height                                                    | `number`  | Высота области просмотра (viewport).                                             |
| width                                                     | `number`  | _Опционально_. Ширина области просмотра.                                            |
| is_expanded                          | `boolean` | Расширена ли в данный момент область просмотра.                                                     |
| is_state_stable | `boolean` | Является ли текущее состояние области просмотра стабильным и не изменится ли оно в ближайшее время. |

> [!СОВЕТ]
> Обратите внимание на то, что скорость отправки данных этим методом недостаточна для плавного изменения размера окна приложения. Вероятно, вам следует использовать стабильную высоту вместо текущей, или решить эту проблему другим способом.

### `visibility_changed`

Доступно с **версии 8.0**

Активное состояние предполагает, что собственный клиент Telegram в данный момент работает с текущим мини-приложением. Важно отметить, что это связано не с
видимостью мини-приложения, а скорее с его выделением среди других открытых в данный момент мини-приложений.

| Поле                            | Тип       | Описание                                                          |
| ------------------------------- | --------- | ----------------------------------------------------------------- |
| is_visible | `boolean` | Указывает, активно ли приложение в данный момент. |

### `write_access_requested`

Доступно с **версии 6.9**

Приложение получило статус запроса на доступ к записи.

| Поле   | Тип      | Описание                                                                                     |
| ------ | -------- | -------------------------------------------------------------------------------------------- |
| status | `string` | Статус запроса. Может быть только `allowed` или `cancelled`. |
